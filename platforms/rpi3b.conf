#!/usr/bin/env bash

# =======================================================
# Retro Pangui Platform Configuration - Raspberry Pi 3B/3B+
# 파일명: platforms/rpi3b.conf
# 설명: Raspberry Pi 3 Model B/B+ (ARMv8/ARMv7, Cortex-A53, VideoCore IV) 전용 설정
# =======================================================

# --- RetroArch 버전 설정 ---
RA_VERSION=""
RA_BRANCH="master"

# --- 활성화 코어 목록 ---
# RPi3B+는 중급 성능 - 기본 코어 중심
PLATFORM_ENABLED_CORES=(
    "${COMMON_ENABLED_CORES[@]}"
    "lr-pcsx-rearmed"       # PlayStation 1
    "lr-mupen64plus-next"   # Nintendo 64 (일부 게임)
    "lr-flycast"            # Dreamcast (일부 게임)
)

# --- 비활성화 코어 목록 ---
PLATFORM_DISABLED_CORES=(
    "lr-dolphin"            # GameCube/Wii - 너무 무겁움
    "lr-citra"              # 3DS - 너무 무겁움
    "lr-ppsspp"             # PSP - 성능 부족
    "lr-beetle-psx-hw"      # PS1 하드웨어 가속 - VideoCore IV 한계
)

# --- 빌드 옵션 ---
# Cortex-A53 최적화 (ARMv8이지만 32bit로도 실행 가능)
# 64bit OS: aarch64, 32bit OS: armv7l
if [ "$__platform_arch" = "aarch64" ]; then
    # 64bit 모드
    PLATFORM_CFLAGS="-mcpu=cortex-a53 -mtune=cortex-a53"
else
    # 32bit 모드
    PLATFORM_CFLAGS="-mcpu=cortex-a53 -mtune=cortex-a53 -mfpu=neon-fp-armv8 -mfloat-abi=hard"
fi
PLATFORM_LDFLAGS=""
PLATFORM_MAKEFLAGS="-j4"  # RPi3B+는 4코어

# --- GPU 백엔드 설정 ---
# VideoCore IV GPU - GLES 지원
USE_OPENGL="no"
USE_GLES="yes"          # OpenGL ES 2.0
USE_VULKAN="no"         # VideoCore IV는 Vulkan 미지원
USE_KMS="yes"
USE_WAYLAND="no"
USE_X11="no"

# --- 최적화 레벨 ---
OPT_LEVEL="-O2"         # O3는 때때로 불안정할 수 있음

# --- RetroArch configure 옵션 ---
RA_CONFIGURE_OPTS=(
    "--prefix=$INSTALL_ROOT_DIR"
    "--disable-x11"
    "--disable-wayland"
    "--disable-opengl"
    "--enable-opengles"
    "--enable-kms"
    "--enable-egl"
    "--enable-udev"
    "--enable-alsa"
    "--enable-threads"
    "--enable-ffmpeg"
    "--enable-7zip"
    "--enable-sdl2"
    "--enable-neon"
)

# --- 추가 환경 변수 ---
export CFLAGS="$PLATFORM_CFLAGS $OPT_LEVEL"
export CXXFLAGS="$PLATFORM_CFLAGS $OPT_LEVEL"

# --- RPi 특화 설정 ---
export RPI_MODEL="3b"
export VIDEOCORE_VERSION="iv"
