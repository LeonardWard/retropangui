#!/usr/bin/env bash

# =======================================================
# Retro Pangui Platform Configuration - Odroid C5
# 파일명: platforms/odroidc5.conf
# 설명: Odroid C5 (ARM64, Cortex-A55, Mali-G31) 전용 설정
# =======================================================

# 필수 패키지 설치 (debian/ubuntu)
# ---------------------------------
# sudo apt install \
#   git build-essential pkg-config \
#   libgbm-dev libdrm-dev \
#   libsdl2-dev \
#   libudev-dev \
#   libegl1-mesa-dev \
#   libasound2-dev \
#   libwayland-dev \
#   libvulkan-dev \
#   libssl-dev \
#   zlib1g-dev \
#   libavformat-dev libavcodec-dev libavutil-dev libswscale-dev libswresample-dev \
#   liblzma-dev \
#   libfreetype6-dev libfontconfig1-dev \
#   libsystemd-dev \
#   libfribidi-dev \
#   libass-dev \
#   libopenal-dev \
#   libmbedtls-dev

# 불필요 및 비호환 라이브러리/헤더 정보
# ---------------------------------
# 아래 라이브러리와 헤더는 Odroid C5 (aarch64, Ubuntu) 환경에서 미지원/비호환입니다.
# configure 옵션에서 자동으로 감지/비활성화되며, 설치하지 않아도 됩니다.
# -lvcos, -lvchiq_arm, -lbcm_host, -lossaudio, -ldinput8, -ld3d9, -ldsound, -ld3dx8, -ld3dx9
# sys/audioio.h, soundcard.h

# 추가적으로, configure 단계에서 해당 기능 비활성화 필요시 아래 옵션을 사용하십시오.
#   --disable-rpi --disable-oss --disable-directx --disable-win32

# --- RetroArch 버전 설정 ---
# Odroid C5에서 안정적으로 동작하는 버전 사용
# lsb_release -a
# 하드커널에서 공식 배포되는 버전이 Ubuntu 24.04.3 LTS 이므로 RA 버전 하향 필요가 있다.

RA_VERSION="v1.10.3"
RA_BRANCH=""

# --- 활성화 코어 목록 ---
# ARM64 성능 고려하여 중저사양 코어 중심
PLATFORM_ENABLED_CORES=(
    "${COMMON_ENABLED_CORES[@]}"
    "lr-pcsx-rearmed"       # PlayStation 1 (ARM 최적화 버전)
    "lr-mupen64plus-next"   # Nintendo 64
    "lr-flycast"            # Dreamcast
    "lr-beetle-psx-hw"      # PS1 (하드웨어 가속)
)

# --- 비활성화 코어 목록 ---
# 고성능 요구 코어는 비활성화
PLATFORM_DISABLED_CORES=(
    "lr-dolphin"            # GameCube/Wii - 너무 무겁움
    "lr-citra"              # 3DS - 너무 무겁움
)

# --- 빌드 옵션 ---
# Cortex-A55 최적화 (Odroid C5 CPU)
PLATFORM_CFLAGS="-mcpu=cortex-a55 -mtune=cortex-a55"
PLATFORM_LDFLAGS=""
PLATFORM_MAKEFLAGS="-j4"  # Odroid C5는 4코어

# --- GPU 백엔드 설정 ---
# Mali-G31 (G310) GPU - Ubuntu 22.04+ Vulkan 지원!
USE_OPENGL="no"         # 데스크탑 GL 비활성화
USE_GLES="yes"          # OpenGL ES 3.2 지원
USE_VULKAN="yes"        # ✨ Vulkan 1.0+ 지원 (Ubuntu 22.04+)
USE_KMS="yes"           # KMS/DRM 사용 (권장)
USE_WAYLAND="yes"       # Wayland + Vulkan 지원
USE_X11="no"            # 임베디드 환경에서 X11 사용 안 함

# --- 최적화 레벨 ---
OPT_LEVEL="-O3 -ffast-math"

# --- Mali GPU 관련 설정 ---
MALI_VERSION="g31"
USE_MALI_FBDEV="no"     # 최신 커널은 KMS 사용
USE_MALI_KMS="yes"

# --- RetroArch configure 옵션 ---
RA_CONFIGURE_OPTS=(
    "--prefix=$INSTALL_ROOT_DIR"
    "--disable-x11"
    "--enable-wayland"      # Wayland 활성화
    "--disable-opengl"
    "--enable-opengles"
    "--enable-opengles3"
    "--enable-vulkan"       # ✨ Vulkan 활성화
    "--enable-kms"
    "--enable-egl"
    "--enable-udev"
    "--enable-alsa"
    "--enable-threads"
    "--enable-ffmpeg"
    "--enable-7zip"
    "--enable-sdl2"
    "--enable-neon"
)

# --- 추가 환경 변수 ---
# ARM NEON 활성화
export CFLAGS="$PLATFORM_CFLAGS $OPT_LEVEL"
export CXXFLAGS="$PLATFORM_CFLAGS $OPT_LEVEL"
